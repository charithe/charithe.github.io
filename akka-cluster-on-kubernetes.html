<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="One of the challenges of running an Akka cluster application is the bootstrapping step required to discover other nodes in the cluster. This post illustrates how to make use of Kubernetes headless ...">
        <meta name="keywords" content="Actors, Akka, Kubernetes, Scala">
        <link rel="icon" href="http://charithe.github.io/favicon.ico">

        <title>Akka Cluster On Kubernetes - Lucid Electric Dreams</title>

        <!-- Stylesheets -->
        <link href="http://charithe.github.io/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Full Atom Feed" />
        <link href="http://charithe.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="http://charithe.github.io/"><img class="mr20" src="http://charithe.github.io/images/logo.png" alt="logo">Lucid Electric Dreams</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="http://charithe.github.io/">Homepage</a>
                                <a href="http://charithe.github.io/categories.html">Categories</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Akka Cluster On Kubernetes</h1>
                      <p class="header-date"> <a href="http://charithe.github.io/author/cell.html">CEll</a>, Tue 17 May 2016,  <a href="http://charithe.github.io/category/programming.html">Programming</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="http://charithe.github.io/tag/actors.html">Actors</a>, <a href="http://charithe.github.io/tag/akka.html">Akka</a>, <a href="http://charithe.github.io/tag/kubernetes.html">Kubernetes</a>, <a href="http://charithe.github.io/tag/scala.html">Scala</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>One of the challenges of running an Akka cluster application is the bootstrapping step required to discover other nodes in the cluster. This post illustrates how to make use of Kubernetes headless services to deploy an Akka cluster that automatically discovers its peers.</p>
<p>Normally, Kubernetes services resolve to a single IP address belonging to one of the child containers that match the selection criteria. A headless service, on the other hand, return a list of all the IP addresses that are under its watch. This is achieved by setting the <code>clusterIP</code> field to <code>None</code>.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">discovery-svc</span>
    <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">discovery-svc</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-akka-app</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">clusterIP</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">None</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">discovery-port</span>
          <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2600</span>
    <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-node</span>
</pre></div>


<p>Next we define a deployment spec for the cluster application itself. The following spec sets the initial cluster size to three nodes. The crucial bit is the definition of an environment variable named <code>DISCOVERY_SERVICE</code> which is set to the value of the Kubernetes cluster DNS entry for the service we defined earlier  (on Google Container Engine this is usually the name of the service followed by <code>default.svc.cluster.local</code>). Please note that typically service information is exposed by Kubernetes as environment variables of the form <code>&lt;normalised_service_name&gt;_SERVICE_HOST</code> and <code>&lt;normalised_service_name&gt;_SERVICE_PORT</code> (in this example, the variables would be <code>DISCOVERY_SVC_SERVICE_HOST</code> and <code>DISCOVERY_SVC_SERVICE_PORT</code>). However, I had trouble accessing these variables from within my containers -- hence the need to define an explicit variable with the hard-coded service DNS entry.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-dep</span>
    <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-dep</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-akka-app</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
    <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-node</span>
            <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-node</span>
                <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-akka-app</span>
        <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">terminationGracePeriodSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
            <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-docker-registry.com/my-akka-app:1.0</span>
                  <span class="l l-Scalar l-Scalar-Plain">imagePullPolicy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
                  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-node</span>
                  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
                    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-port</span>
                      <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2600</span>
                  <span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>
                    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DISCOVERY_SERVICE</span>
                      <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">discovery-svc.default.svc.cluster.local</span>
                  <span class="l l-Scalar l-Scalar-Plain">livenessProbe</span><span class="p p-Indicator">:</span>
                    <span class="l l-Scalar l-Scalar-Plain">tcpSocket</span><span class="p p-Indicator">:</span>
                      <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2600</span>
                    <span class="l l-Scalar l-Scalar-Plain">initialDelaySeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">15</span>
                    <span class="l l-Scalar l-Scalar-Plain">timeoutSeconds</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
</pre></div>


<p>In order for the discovery to work, we need to bootstrap the application as follows:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">conf</span> <span class="k">=</span> <span class="n">resolveConfig</span><span class="o">(</span><span class="s">&quot;MyCluster&quot;</span><span class="o">,</span> <span class="mi">2600</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">actorSystem</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;MyCluster&quot;</span><span class="o">,</span> <span class="n">conf</span><span class="o">)</span>
  <span class="c1">// rest of the init code</span>
<span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">resolveConfig</span><span class="o">(</span><span class="n">actorSystemName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">port</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Config</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">hostAddress</span> <span class="k">=</span> <span class="n">getHostAddress</span>
  <span class="k">val</span> <span class="n">seedNodes</span> <span class="k">=</span> <span class="n">getSeedNodes</span><span class="o">(</span><span class="n">hostAddress</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>

  <span class="nc">ConfigFactory</span><span class="o">.</span><span class="n">empty</span><span class="o">()</span>
    <span class="o">.</span><span class="n">withValue</span><span class="o">(</span><span class="s">&quot;akka.cluster.seed-nodes&quot;</span><span class="o">,</span> <span class="nc">ConfigValueFactory</span><span class="o">.</span><span class="n">fromIterable</span><span class="o">(</span><span class="n">seedNodes</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">node</span> <span class="k">=&gt;</span> <span class="s">s&quot;akka.tcp://</span><span class="si">${</span><span class="n">actorSystemName</span><span class="si">}</span><span class="s">@</span><span class="si">$node</span><span class="s">&quot;</span><span class="o">)))</span>
    <span class="o">.</span><span class="n">withValue</span><span class="o">(</span><span class="s">&quot;akka.remote.netty.tcp.hostname&quot;</span><span class="o">,</span> <span class="nc">ConfigValueFactory</span><span class="o">.</span><span class="n">fromAnyRef</span><span class="o">(</span><span class="n">hostAddress</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withValue</span><span class="o">(</span><span class="s">&quot;akka.remote.netty.tcp.port&quot;</span><span class="o">,</span> <span class="nc">ConfigValueFactory</span><span class="o">.</span><span class="n">fromAnyRef</span><span class="o">(</span><span class="n">port</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="n">load</span><span class="o">())</span>
    <span class="o">.</span><span class="n">resolve</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">getSeedNodes</span><span class="o">(</span><span class="n">hostAddress</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">port</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// try to resolve the list of IP addresses from the discovery service or return local address</span>
    <span class="k">val</span> <span class="n">seedNodes</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">getenv</span><span class="o">(</span><span class="s">&quot;DISCOVERY_SERVICE&quot;</span><span class="o">)).</span><span class="n">fold</span><span class="o">(</span><span class="nc">Seq</span><span class="o">.</span><span class="n">empty</span><span class="o">)(</span><span class="nc">InetAddress</span><span class="o">.</span><span class="n">getAllByName</span><span class="o">(</span><span class="k">_</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">addr</span> <span class="k">=&gt;</span> <span class="s">s&quot;</span><span class="si">${</span><span class="n">addr</span><span class="o">.</span><span class="n">getHostAddress</span><span class="si">}</span><span class="s">:</span><span class="si">$port</span><span class="s">&quot;</span><span class="o">))</span>
    <span class="k">if</span><span class="o">(</span><span class="n">seedNodes</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">){</span>
      <span class="nc">Seq</span><span class="o">(</span><span class="s">s&quot;</span><span class="si">$hostAddress</span><span class="s">:</span><span class="si">$port</span><span class="s">&quot;</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">seedNodes</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">getHostAddress</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
  <span class="nc">NetworkInterface</span><span class="o">.</span><span class="n">getNetworkInterfaces</span>
    <span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">getName</span> <span class="n">equals</span> <span class="s">&quot;eth0&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">interface</span> <span class="k">=&gt;</span>
      <span class="n">interface</span><span class="o">.</span><span class="n">getInetAddresses</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">isSiteLocalAddress</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">getHostAddress</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="http://charithe.github.io/archives.html">Archives</a></li>
                            <li><a href="http://charithe.github.io/tags.html">Tags</a></li>
                            <li><a href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; 2016  Charith Ellawala </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>