<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Most stream processing frameworks require the implementer to define the processing logic using some sort of a DSL -- which then gets compiled and materialised into the framework&#39;s primitives at ...">
        <meta name="keywords" content="Actors, Akka, Scala">
        <link rel="icon" href="http://charithe.github.io/favicon.ico">

        <title>Dynamic Akka Streams Using Stage Actors - Lucid Electric Dreams</title>

        <!-- Stylesheets -->
        <link href="http://charithe.github.io/theme/css/bootstrap.min.css" rel="stylesheet">
        <link href="http://charithe.github.io/theme/css/fonts.css" rel="stylesheet">
        <link href="http://charithe.github.io/theme/css/nest.css" rel="stylesheet">
        <link href="http://charithe.github.io/theme/css/pygment.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Full Atom Feed" />
        <link href="http://charithe.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="http://charithe.github.io/"><img class="mr20" src="http://charithe.github.ioimages/logo.png" alt="logo">Lucid Electric Dreams</a>
                    </div>
                    <div class="nav pull-right">
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Dynamic Akka Streams Using Stage Actors</h1>
                      <p class="header-date"> <a href="http://charithe.github.io/author/cell.html">CEll</a>, Fri 15 May 2015,  <a href="http://charithe.github.io/category/programming.html">Programming</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="http://charithe.github.io/tag/actors.html">Actors</a>, <a href="http://charithe.github.io/tag/akka.html">Akka</a>, <a href="http://charithe.github.io/tag/scala.html">Scala</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>Most stream processing frameworks require the implementer to define the processing logic using some sort of a DSL -- which then gets compiled and materialised into the framework's primitives at run time. The user has very little control over the pipeline once it starts executing. Any changes to the processing stages requires a re-compilation and a re-deployment. Getting around this limitation is not impossible but requires inelegant and costly operations such as polling an external service or a data store for updates.</p>
<p><a href="http://doc.akka.io/docs/akka/2.4.4/scala/stream/#streams-scala">Akka Streams</a> are materialised and run on top of actors but the DSL (understandably) completely hides this fact from the implementers. Letting users directly interact with actors could lead to inconsistent behaviour and even destabilise the entire pipeline. However,  in the recent releases of Akka streams, users are now able to access a so-called stage actor from within their custom graph stages. Stage actors are not fully-fledged actors and only support a subset of operations on them . This allows the framework to deal with the issues of maintaining consistency and thread-safety of the internal state during interactions with the stage actor.</p>
<p>To illustrate, I built a very rudimentary keyword-based tagging flow that can receive updates to keywords and tags while the system is running. <code>TagStage</code> is a custom graph stage that registers its' stage actor with an external coordinator actor on startup. The coordinator is then able to send messages to the stage actor -- which updates the internal map containing keywords and tags based on the received messages. When the internal state change is applied, the next element passed into the stage will be processed using the newly updated map -- thus changing the output of the system dynamically.</p>
<p>The <code>TagStage</code> implementation is as follows:</p>
<div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.ActorRef</span>
<span class="k">import</span> <span class="nn">akka.stream.</span><span class="o">{</span><span class="nc">Attributes</span><span class="o">,</span> <span class="nc">FlowShape</span><span class="o">,</span> <span class="nc">Inlet</span><span class="o">,</span> <span class="nc">Outlet</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.collection.mutable</span>
<span class="k">import</span> <span class="nn">akka.stream.stage.</span><span class="o">{</span><span class="nc">GraphStage</span><span class="o">,</span> <span class="nc">GraphStageLogic</span><span class="o">,</span> <span class="nc">InHandler</span><span class="o">,</span> <span class="nc">OutHandler</span><span class="o">}</span>

<span class="k">class</span> <span class="nc">TagStage</span><span class="o">(</span><span class="n">stageCoordinator</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">initialKeywordsMap</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">GraphStage</span><span class="o">[</span><span class="kt">FlowShape</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]]]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">in</span><span class="k">:</span> <span class="kt">Inlet</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Inlet</span><span class="o">(</span><span class="s">&quot;tag-stage-in&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Outlet</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Outlet</span><span class="o">(</span><span class="s">&quot;tag-stage-out&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">shape</span><span class="k">:</span> <span class="kt">FlowShape</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">FlowShape</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">out</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">createLogic</span><span class="o">(</span><span class="n">inheritedAttributes</span><span class="k">:</span> <span class="kt">Attributes</span><span class="o">)</span><span class="k">:</span> <span class="kt">GraphStageLogic</span> <span class="o">=</span>  <span class="k">new</span> <span class="nc">GraphStageLogic</span><span class="o">(</span><span class="n">shape</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">implicit</span> <span class="k">def</span> <span class="n">self</span> <span class="k">=</span> <span class="n">stageActor</span><span class="o">.</span><span class="n">ref</span>

    <span class="k">var</span> <span class="n">keywordsMap</span> <span class="k">=</span> <span class="n">mutable</span><span class="o">.</span><span class="nc">HashMap</span><span class="o">(</span><span class="n">initialKeywordsMap</span><span class="o">.</span><span class="n">toSeq</span><span class="k">:_</span><span class="kt">*</span><span class="o">)</span>

    <span class="n">setHandler</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="k">new</span> <span class="nc">InHandler</span> <span class="o">{</span>
      <span class="k">override</span> <span class="k">def</span> <span class="n">onPush</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="c1">// Grab the next message from the inlet</span>
        <span class="k">val</span> <span class="n">msg</span> <span class="k">=</span> <span class="n">grab</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
        <span class="c1">// Tokenize the message and find all applicable tags</span>
        <span class="k">val</span> <span class="n">tags</span> <span class="k">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\\W+&quot;</span><span class="o">).</span><span class="n">collect</span> <span class="o">{</span>
          <span class="k">case</span> <span class="n">flaggedWord</span> <span class="k">if</span> <span class="n">keywordsMap</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">flaggedWord</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">keywordsMap</span><span class="o">(</span><span class="n">flaggedWord</span><span class="o">)</span>
        <span class="o">}.</span><span class="n">flatten</span>

        <span class="k">if</span><span class="o">(</span><span class="n">tags</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">){</span>
          <span class="c1">// if there are no tags to output, request next item from upstream</span>
          <span class="n">tryPull</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">// push the tags downstream</span>
          <span class="n">push</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="nc">Set</span><span class="o">(</span><span class="n">tags</span><span class="k">:_</span><span class="kt">*</span><span class="o">))</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">})</span>

    <span class="n">setHandler</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="k">new</span> <span class="nc">OutHandler</span> <span class="o">{</span>
      <span class="c1">// Request next item from upstream</span>
      <span class="k">override</span> <span class="k">def</span> <span class="n">onPull</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">tryPull</span><span class="o">(</span><span class="n">in</span><span class="o">)</span>
    <span class="o">})</span>

    <span class="k">override</span> <span class="k">def</span> <span class="n">preStart</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="c1">// Register the stage actor with the coordinator actor</span>
      <span class="k">val</span> <span class="n">thisStageActor</span> <span class="k">=</span> <span class="n">getStageActor</span><span class="o">(</span><span class="n">messageHandler</span><span class="o">).</span><span class="n">ref</span>
      <span class="n">stageCoordinator</span> <span class="o">!</span> <span class="nc">StageCoordinator</span><span class="o">.</span><span class="nc">Register</span><span class="o">(</span><span class="n">thisStageActor</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">private</span> <span class="k">def</span> <span class="n">messageHandler</span><span class="o">(</span><span class="n">receive</span><span class="k">:</span> <span class="o">(</span><span class="kt">ActorRef</span><span class="o">,</span> <span class="kt">Any</span><span class="o">))</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">receive</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="nc">StageCoordinator</span><span class="o">.</span><span class="nc">AddKeywordTags</span><span class="o">(</span><span class="n">keyword</span><span class="o">,</span> <span class="n">tags</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="o">{</span>
          <span class="c1">// Add a new set of tags for the keyword</span>
          <span class="k">val</span> <span class="n">newTags</span> <span class="k">=</span> <span class="n">keywordsMap</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">keyword</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">++</span> <span class="n">tags</span><span class="o">).</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">tags</span><span class="o">)</span>
          <span class="n">keywordsMap</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">keyword</span><span class="o">,</span> <span class="n">newTags</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="k">case</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="nc">StageCoordinator</span><span class="o">.</span><span class="nc">RemoveKeyword</span><span class="o">(</span><span class="n">keyword</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="o">{</span>
          <span class="c1">// Remove the keyword</span>
          <span class="n">keywordsMap</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">keyword</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The coordinator actor just needs to store the references to the registered stage actors and forward any received messages to them.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.</span><span class="p">{</span><span class="n">Actor</span><span class="p">,</span> <span class="n">ActorLogging</span><span class="p">,</span> <span class="n">ActorRef</span><span class="p">,</span> <span class="n">Props</span><span class="p">,</span> <span class="n">Terminated</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">com.github.charithe.akka.streams.StageCoordinator.</span><span class="p">{</span><span class="n">Register</span><span class="p">,</span> <span class="n">TagCommand</span><span class="p">}</span>

<span class="kn">import</span> <span class="nn">scala.collection.mutable</span>

<span class="k">class</span> <span class="nc">StageCoordinator</span> <span class="n">extends</span> <span class="n">Actor</span> <span class="k">with</span> <span class="n">ActorLogging</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">stageActors</span><span class="p">:</span> <span class="n">mutable</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="n">ActorRef</span><span class="p">]</span> <span class="o">=</span> <span class="n">mutable</span><span class="o">.</span><span class="n">HashSet</span><span class="o">.</span><span class="n">empty</span>

  <span class="n">override</span> <span class="k">def</span> <span class="nf">receive</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">case</span> <span class="n">Register</span><span class="p">(</span><span class="n">actorRef</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Registering stage actor [{}]&quot;</span><span class="p">,</span> <span class="n">actorRef</span><span class="p">)</span>
      <span class="n">stageActors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">actorRef</span><span class="p">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">actorRef</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">case</span> <span class="n">Terminated</span><span class="p">(</span><span class="n">actorRef</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stage actor terminated [{}]&quot;</span><span class="p">,</span> <span class="n">actorRef</span><span class="p">)</span>
      <span class="n">stageActors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">actorRef</span><span class="p">)</span>
      <span class="n">context</span><span class="o">.</span><span class="n">unwatch</span><span class="p">(</span><span class="n">actorRef</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">case</span> <span class="n">cmd</span><span class="p">:</span> <span class="n">TagCommand</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received command: [{}]&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
      <span class="n">stageActors</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">_</span> <span class="err">!</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nb">object</span> <span class="n">StageCoordinator</span> <span class="p">{</span>

  <span class="n">final</span> <span class="n">case</span> <span class="k">class</span> <span class="nc">Register</span><span class="p">(</span><span class="n">actorRef</span><span class="p">:</span> <span class="n">ActorRef</span><span class="p">)</span>

  <span class="n">sealed</span> <span class="n">trait</span> <span class="n">TagCommand</span> <span class="n">extends</span> <span class="n">Product</span> <span class="k">with</span> <span class="n">Serializable</span>

  <span class="n">final</span> <span class="n">case</span> <span class="k">class</span> <span class="nc">AddKeywordTags</span><span class="p">(</span><span class="n">keyword</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">String</span><span class="p">])</span> <span class="n">extends</span> <span class="n">TagCommand</span>

  <span class="n">final</span> <span class="n">case</span> <span class="k">class</span> <span class="nc">RemoveKeyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="n">extends</span> <span class="n">TagCommand</span>

  <span class="k">def</span> <span class="nf">props</span> <span class="o">=</span> <span class="n">Props</span><span class="p">[</span><span class="n">StageCoordinator</span><span class="p">]</span>

<span class="p">}</span>
</pre></div>


<p>Finally, the entire pipeline can be tested using the streams testkit.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.ActorSystem</span>
<span class="kn">import</span> <span class="nn">akka.stream.ActorMaterializer</span>
<span class="kn">import</span> <span class="nn">akka.stream.scaladsl.</span><span class="p">{</span><span class="n">Flow</span><span class="p">,</span> <span class="n">Keep</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">akka.stream.testkit.scaladsl.</span><span class="p">{</span><span class="n">TestSink</span><span class="p">,</span> <span class="n">TestSource</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">akka.testkit.</span><span class="p">{</span><span class="n">ImplicitSender</span><span class="p">,</span> <span class="n">TestKit</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">org.scalatest.</span><span class="p">{</span><span class="n">BeforeAndAfterAll</span><span class="p">,</span> <span class="n">FunSuiteLike</span><span class="p">,</span> <span class="n">Matchers</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">TagStageTest</span><span class="p">(</span><span class="n">_system</span><span class="p">:</span> <span class="n">ActorSystem</span><span class="p">)</span> <span class="n">extends</span> <span class="n">TestKit</span><span class="p">(</span><span class="n">_system</span><span class="p">)</span> <span class="k">with</span> <span class="n">ImplicitSender</span> <span class="k">with</span> <span class="n">FunSuiteLike</span> <span class="k">with</span> <span class="n">Matchers</span> <span class="k">with</span> <span class="n">BeforeAndAfterAll</span>  <span class="p">{</span>
  <span class="n">val</span> <span class="n">TestMessage</span> <span class="o">=</span> <span class="s2">&quot;akka is a toolkit and runtime for building highly concurrent, distributed, and resilient message-driven applications on the JVM&quot;</span>
  <span class="n">implicit</span> <span class="n">val</span> <span class="n">materializer</span> <span class="o">=</span> <span class="n">ActorMaterializer</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">this</span><span class="p">()</span> <span class="o">=</span> <span class="n">this</span><span class="p">(</span><span class="n">ActorSystem</span><span class="p">(</span><span class="s2">&quot;tag-stage-test&quot;</span><span class="p">))</span>

  <span class="n">override</span> <span class="k">def</span> <span class="nf">afterAll</span><span class="p">():</span> <span class="n">Unit</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">TestKit</span><span class="o">.</span><span class="n">shutdownActorSystem</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">(</span><span class="s2">&quot;Dynamic stage&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Create</span> <span class="n">the</span> <span class="n">tag</span> <span class="n">stage</span> <span class="k">with</span> <span class="n">testActor</span> <span class="k">as</span> <span class="n">the</span> <span class="n">coordinator</span> <span class="n">actor</span>
    <span class="n">val</span> <span class="n">tagStage</span> <span class="o">=</span> <span class="n">Flow</span><span class="o">.</span><span class="n">fromGraph</span><span class="p">(</span><span class="n">new</span> <span class="n">TagStage</span><span class="p">(</span><span class="n">testActor</span><span class="p">,</span> <span class="n">Map</span><span class="p">(</span><span class="s2">&quot;akka&quot;</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">(</span><span class="s2">&quot;scala&quot;</span><span class="p">,</span> <span class="s2">&quot;actors&quot;</span><span class="p">))))</span>

    <span class="o">//</span> <span class="n">Create</span> <span class="n">the</span> <span class="n">flow</span>
    <span class="n">val</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">snk</span><span class="p">)</span> <span class="o">=</span> <span class="n">TestSource</span><span class="o">.</span><span class="n">probe</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
      <span class="o">.</span><span class="n">via</span><span class="p">(</span><span class="n">tagStage</span><span class="p">)</span>
      <span class="o">.</span><span class="n">toMat</span><span class="p">(</span><span class="n">TestSink</span><span class="o">.</span><span class="n">probe</span><span class="p">)(</span><span class="n">Keep</span><span class="o">.</span><span class="n">both</span><span class="p">)</span>
      <span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="o">//</span> <span class="n">expect</span> <span class="n">registration</span> <span class="ow">and</span> <span class="n">subscription</span> <span class="n">start</span> <span class="n">messages</span>
    <span class="n">val</span> <span class="n">stageActorRegistration</span> <span class="o">=</span> <span class="n">expectMsgType</span><span class="p">[</span><span class="n">StageCoordinator</span><span class="o">.</span><span class="n">Register</span><span class="p">]</span>
    <span class="n">val</span> <span class="n">subscription</span> <span class="o">=</span> <span class="n">snk</span><span class="o">.</span><span class="n">expectSubscription</span><span class="p">()</span>

    <span class="o">//</span> <span class="n">Send</span> <span class="n">a</span> <span class="n">message</span> <span class="n">through</span> <span class="n">the</span> <span class="n">pipeline</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">src</span><span class="o">.</span><span class="n">sendNext</span><span class="p">(</span><span class="n">TestMessage</span><span class="p">)</span>

    <span class="n">val</span> <span class="n">tagResult1</span> <span class="o">=</span> <span class="n">snk</span><span class="o">.</span><span class="n">expectNext</span><span class="p">()</span>
    <span class="n">tagResult1</span> <span class="n">should</span> <span class="n">have</span> <span class="n">size</span> <span class="mi">2</span>
    <span class="n">tagResult1</span> <span class="n">should</span> <span class="n">contain</span> <span class="p">(</span><span class="s2">&quot;scala&quot;</span><span class="p">)</span>
    <span class="n">tagResult1</span> <span class="n">should</span> <span class="n">contain</span> <span class="p">(</span><span class="s2">&quot;actors&quot;</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Update</span> <span class="n">the</span> <span class="n">keyword</span> <span class="n">tag</span> <span class="nb">set</span> <span class="n">through</span> <span class="n">the</span> <span class="n">stage</span> <span class="n">actor</span>
    <span class="n">stageActorRegistration</span><span class="o">.</span><span class="n">actorRef</span> <span class="err">!</span> <span class="n">StageCoordinator</span><span class="o">.</span><span class="n">AddKeywordTags</span><span class="p">(</span><span class="s2">&quot;akka&quot;</span><span class="p">,</span> <span class="n">Set</span><span class="p">(</span><span class="s2">&quot;jvm&quot;</span><span class="p">,</span> <span class="s2">&quot;message-driven&quot;</span><span class="p">))</span>

    <span class="o">//</span> <span class="n">Send</span> <span class="n">the</span> <span class="n">message</span> <span class="n">through</span> <span class="n">the</span> <span class="n">pipeline</span> <span class="n">again</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">src</span><span class="o">.</span><span class="n">sendNext</span><span class="p">(</span><span class="n">TestMessage</span><span class="p">)</span>

    <span class="n">val</span> <span class="n">tagResult2</span> <span class="o">=</span> <span class="n">snk</span><span class="o">.</span><span class="n">expectNext</span><span class="p">()</span>
    <span class="n">tagResult2</span> <span class="n">should</span> <span class="n">have</span> <span class="n">size</span> <span class="mi">4</span>
    <span class="n">tagResult2</span> <span class="n">should</span> <span class="n">contain</span> <span class="p">(</span><span class="s2">&quot;scala&quot;</span><span class="p">)</span>
    <span class="n">tagResult2</span> <span class="n">should</span> <span class="n">contain</span> <span class="p">(</span><span class="s2">&quot;actors&quot;</span><span class="p">)</span>
    <span class="n">tagResult2</span> <span class="n">should</span> <span class="n">contain</span> <span class="p">(</span><span class="s2">&quot;jvm&quot;</span><span class="p">)</span>
    <span class="n">tagResult2</span> <span class="n">should</span> <span class="n">contain</span> <span class="p">(</span><span class="s2">&quot;message-driven&quot;</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Remove</span> <span class="n">the</span> <span class="n">keyword</span> <span class="n">through</span> <span class="n">the</span> <span class="n">stage</span> <span class="n">actor</span>
    <span class="n">stageActorRegistration</span><span class="o">.</span><span class="n">actorRef</span> <span class="err">!</span> <span class="n">StageCoordinator</span><span class="o">.</span><span class="n">RemoveKeyword</span><span class="p">(</span><span class="s2">&quot;akka&quot;</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Send</span> <span class="n">the</span> <span class="n">message</span> <span class="n">through</span> <span class="n">the</span> <span class="n">pipeline</span> <span class="n">again</span>
    <span class="n">subscription</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">src</span><span class="o">.</span><span class="n">sendNext</span><span class="p">(</span><span class="n">TestMessage</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Since</span> <span class="n">there</span> <span class="n">are</span> <span class="n">no</span> <span class="n">keywords</span> <span class="n">to</span> <span class="n">match</span><span class="p">,</span> <span class="n">nothing</span> <span class="n">should</span> <span class="n">come</span> <span class="n">out</span>
    <span class="n">snk</span><span class="o">.</span><span class="n">expectNoMsg</span><span class="p">()</span>

    <span class="o">//</span> <span class="n">Shutdown</span> <span class="n">the</span> <span class="n">flow</span>
    <span class="n">src</span><span class="o">.</span><span class="n">sendComplete</span><span class="p">()</span>
    <span class="n">snk</span><span class="o">.</span><span class="n">expectComplete</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Source code for the project can be found <a href="https://github.com/charithe/akka-stage-actor">here</a> </p>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title"></div>
                        <ul class="list-unstyled">
                            <li><a href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"></a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small></small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>