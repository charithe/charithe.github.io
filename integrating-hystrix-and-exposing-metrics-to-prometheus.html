<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Hystrix is a well-known fault tolerance library for distributed systems. If your application needs to interact with remote systems (or even micro-services running in the same data center), Hystrix ...">
        <meta name="keywords" content="Hystrix, Java, Metrics, Monitoring, Prometheus, Rx">
        <link rel="icon" href="http://charithe.github.io/favicon.ico">

        <title>Integrating Hystrix And Exposing Metrics To Prometheus - Lucid Electric Dreams</title>

        <!-- Stylesheets -->
        <link href="http://charithe.github.io/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Full Atom Feed" />
        <link href="http://charithe.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="http://charithe.github.io/"><img class="mr20" src="http://charithe.github.io/images/logo.png" alt="logo">Lucid Electric Dreams</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="http://charithe.github.io/">Homepage</a>
                                <a href="http://charithe.github.io/categories.html">Categories</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Integrating Hystrix And Exposing Metrics To Prometheus</h1>
                      <p class="header-date"> <a href="http://charithe.github.io/author/cell.html">CEll</a>, Mon 09 January 2017,  <a href="http://charithe.github.io/category/programming.html">Programming</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="http://charithe.github.io/tag/hystrix.html">Hystrix</a>, <a href="http://charithe.github.io/tag/java.html">Java</a>, <a href="http://charithe.github.io/tag/metrics.html">Metrics</a>, <a href="http://charithe.github.io/tag/monitoring.html">Monitoring</a>, <a href="http://charithe.github.io/tag/prometheus.html">Prometheus</a>, <a href="http://charithe.github.io/tag/rx.html">Rx</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p><a href="https://github.com/Netflix/Hystrix">Hystrix</a> is a well-known fault tolerance library for distributed systems. If your 
application needs to interact with remote systems (or even micro-services running in the same data center), Hystrix will
provide latency-sensitive routing, retries, request coalescing, circuit breakers and many more fault-tolerance features out of the box.
I cannot do much justice to Hystrix in this short brain dump but there are many great articles and presentations around the web that
are well worth perusing.</p>
<p>Integrating Hystrix into an application can be a bit cumbersome as every external interaction needs to be defined as a Hystrix command.
One method I have successfully used to reduce the amount of integration code is to write a wrapper class.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.netflix.hystrix.HystrixCommand</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.netflix.hystrix.HystrixCommandGroupKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.netflix.hystrix.HystrixCommandKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">rx.Single</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Supplier</span><span class="o">;</span>

<span class="c1">// This assumes that your code is already written using RxJava. Hystrix also provides methods for wrapping the result</span>
<span class="c1">// as an Observable as well</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommandWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">HystrixCommand</span><span class="o">&lt;</span><span class="n">Single</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
    <span class="c1">// if there are multiple logically related commands, this should be made into a parameter as well </span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">COMMAND_GROUP_KEY</span> <span class="o">=</span> <span class="s">&quot;MyCommandGroup&quot;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Single</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">wrappedFn</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">commandKey</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">CommandWrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">of</span><span class="o">(</span><span class="n">String</span> <span class="n">commandKey</span><span class="o">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Single</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">wrappedFn</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CommandWrapper</span><span class="o">&lt;&gt;(</span><span class="n">commandKey</span><span class="o">,</span> <span class="n">wrappedFn</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">CommandWrapper</span><span class="o">(</span><span class="n">String</span> <span class="n">commandKey</span><span class="o">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Single</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">wrappedFn</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">Setter</span><span class="o">.</span><span class="na">withGroupKey</span><span class="o">(</span><span class="n">HystrixCommandGroupKey</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">asKey</span><span class="o">(</span><span class="n">COMMAND_GROUP_KEY</span><span class="o">))</span>
                  <span class="o">.</span><span class="na">andCommandKey</span><span class="o">(</span><span class="n">HystrixCommandKey</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">asKey</span><span class="o">(</span><span class="n">commandKey</span><span class="o">)));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">commandKey</span> <span class="o">=</span> <span class="n">commandKey</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">wrappedFn</span> <span class="o">=</span> <span class="n">wrappedFn</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Single</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">wrappedFn</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">HystrixCommandKey</span> <span class="nf">getCommandKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">HystrixCommandKey</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">asKey</span><span class="o">(</span><span class="n">commandKey</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The above wrapper allows your core logic to be written without worrying about Hystrix and yet reap its' benefits  as follows:</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Single</span><span class="o">&lt;</span><span class="n">ApiToken</span><span class="o">&gt;</span> <span class="nf">login</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">CommandWrapper</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;LoginToSystemX&quot;</span><span class="o">,</span> <span class="n">client</span><span class="o">::</span><span class="n">login</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<h2>Prometheus Reporting And Hystrix Dashboard</h2>
<p>Hystrix provides a comprehensive set of metrics that can be viewed live using the <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-dashboard">Hystrix Dashboard</a> or collected using metrics backends such as Netflix Servo. The Hystrix distribution provides a Servlet handler for these integrations but what if the application is not running inside a servlet container and the preferred metrics backend is <a href="https://prometheus.io/">Prometheus</a>. </p>
<p>Two open-source projects come to our rescue here.</p>
<ul>
<li><a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-rx-netty-metrics-stream">Hystrix RxNetty Metrics Stream</a></li>
<li><a href="https://github.com/soundcloud/prometheus-hystrix">SoundCloud's Prometheus-Hystrix</a></li>
</ul>
<p>Unfortunately, SoundCloud <code>prometheus-hystrix</code> library is not released on Maven Central at the time of writing. You can instead make use of 
<a href="https://jitpack.io/">jitpack.io</a> to obtain a build direct from the source release itself. Refer to <a href="https://jitpack.io/#soundcloud/prometheus-hystrix">https://jitpack.io/#soundcloud/prometheus-hystrix</a> for more information. </p>
<p>In Gradle, the dependency requirements are:</p>
<div class="highlight"><pre><span></span>compile group: &#39;com.github.soundcloud&#39;, name: &#39;prometheus-hystrix&#39;, version: &#39;3.1.0&#39;
compile group: &#39;com.netflix.hystrix&#39;, name: &#39;hystrix-rx-netty-metrics-stream&#39;, version: &#39;1.5.8&#39;
</pre></div>


<p>In order to expose Hystrix metrics in the Prometheus format, we need to write a little bit of code:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBufOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpHeaderNames</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpResponseStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.prometheus.client.CollectorRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.prometheus.client.exporter.common.TextFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.reactivex.netty.protocol.http.server.HttpServerResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">rx.Observable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStreamWriter</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrometheusMetrics</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">dumpMetrics</span><span class="o">(</span><span class="n">HttpServerResponse</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">buffer</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">(</span><span class="n">BufferedWriter</span> <span class="n">bufWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">OutputStreamWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteBufOutputStream</span><span class="o">(</span><span class="n">buffer</span><span class="o">))))</span> <span class="o">{</span>
            <span class="n">TextFormat</span><span class="o">.</span><span class="na">write004</span><span class="o">(</span><span class="n">bufWriter</span><span class="o">,</span> <span class="n">CollectorRegistry</span><span class="o">.</span><span class="na">defaultRegistry</span><span class="o">.</span><span class="na">metricFamilySamples</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">writeStringAndFlush</span><span class="o">(</span><span class="s">&quot;ERROR&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">HttpHeaderNames</span><span class="o">.</span><span class="na">CONTENT_TYPE</span><span class="o">,</span> <span class="n">TextFormat</span><span class="o">.</span><span class="na">CONTENT_TYPE_004</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Then, we can write a RxNetty server handler to expose both the Hystrix Dashboard stream and the Prometheus stream as follows:</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MetricsEndpoint</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">METRICS_PORT</span> <span class="o">=</span> <span class="mi">5555</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">HttpServer</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">,</span> <span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">RxNetty</span><span class="o">.</span><span class="na">createHttpServer</span><span class="o">(</span><span class="n">METRICS_PORT</span><span class="o">,</span>
                                        <span class="k">new</span> <span class="n">HystrixMetricsStreamHandler</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="n">MonitorHandler</span><span class="o">())).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MonitorHandler</span> <span class="kd">implements</span> <span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">,</span> <span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">METRICS_PATH</span> <span class="o">=</span> <span class="s">&quot;/metrics&quot;</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">handle</span><span class="o">(</span><span class="n">HttpServerRequest</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServerResponse</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="n">METRICS_PATH</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">PrometheusMetrics</span><span class="o">.</span><span class="na">dumpMetrics</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">writeStringAndFlush</span><span class="o">(</span><span class="s">&quot;BAD REQUEST&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Now once the server is started, the Hystrix Dashboard can be pointed to <code>&lt;server_address&gt;:5555</code> for the live graphs and
the Prometheus scraper can obtain the metrics via <code>&lt;server_address&gt;:5555/metrics</code> as well.</p>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="http://charithe.github.io/archives.html">Archives</a></li>
                            <li><a href="http://charithe.github.io/tags.html">Tags</a></li>
                            <li><a href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; 2016-2017  Charith Ellawala </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>