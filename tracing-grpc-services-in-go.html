<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Built-in tracing with x/net/trace The grpc package contains a variable named EnableTracing that is set to true by default. When tracing is enabled, all requests and responses are recorded ...">
        <meta name="keywords" content="Go, gRPC, Monitoring, Tracing">
        <link rel="icon" href="http://charithe.github.io/favicon.ico">

        <title>Tracing gRPC Services In Go - Lucid Electric Dreams</title>

        <!-- Stylesheets -->
        <link href="http://charithe.github.io/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Full Atom Feed" />
        <link href="http://charithe.github.io/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate" title="Lucid Electric Dreams Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->



    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="http://charithe.github.io/"><img class="mr20" src="http://charithe.github.io/images/logo.png" alt="logo">Lucid Electric Dreams</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="http://charithe.github.io/">Homepage</a>
                                <a href="http://charithe.github.io/categories.html">Categories</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">Tracing gRPC Services In Go</h1>
                      <p class="header-date"> <a href="http://charithe.github.io/author/cell.html">CEll</a>, Sun 26 March 2017,  <a href="http://charithe.github.io/category/programming.html">Programming</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="http://charithe.github.io/tag/go.html">Go</a>, <a href="http://charithe.github.io/tag/grpc.html">gRPC</a>, <a href="http://charithe.github.io/tag/monitoring.html">Monitoring</a>, <a href="http://charithe.github.io/tag/tracing.html">Tracing</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <h2>Built-in tracing with x/net/trace</h2>
<p>The <code>grpc</code> package contains a variable named <code>EnableTracing</code> that is set to true by default. When tracing is enabled, 
all requests and responses are recorded internally by the grpc library using the trace functions provided by the 
<code>x/net/trace</code> package. This package registers two HTTP handlers in <code>http.DefaultServeMux</code> to serve trace information at 
<code>/debug/events</code> and <code>/debug/requests</code> paths by default. Alternatively, <code>trace.Render(...)</code> and <code>trace.RenderEvents(...)</code> 
can be used in your own HTTP handlers to produce the same output.</p>
<p>At the time of writing, the <code>trace</code> package does not have have a persistence mechanism and the rendered information is 
a "live" view of traces held in memory. This makes it unsuitable for after-the-fact analysis.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;http&quot;</span>
    <span class="s">&quot;google.golang.org/grpc&quot;</span>
    <span class="nx">_</span> <span class="s">&quot;golang.org/x/net/trace&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">grpc</span><span class="p">.</span><span class="nx">EnableTracing</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">startGRPCServer</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// start the gRPC server</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">startDebugServer</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Start the default http server and explicitly bind it to listen on localhost for security purposes</span>
    <span class="c1">// Accessing http://localhost:6060/debug/events or http://localhost:6060/debug/requests will show the</span>
    <span class="c1">// currently gathered traces.</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServer</span><span class="p">(</span><span class="s">&quot;localhost:6060&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> 
<span class="p">}</span>
</pre></div>


<h2>Dapper style distributed tracing</h2>
<p>There are several distributed tracing systems modelled after Google Dapper such as Zipkin, Jaeger, Stackdriver Trace etc.
<a href="https://opentracing.io">Opentracing</a> is a vendor-neutral tracing implementation that supports multiple collector backends. 
The Go implementation of the Opentracing API can be found at <a href="https://github.com/opentracing/opentracing-go">https://github.com/opentracing/opentracing-go</a></p>
<p>The most obvious way to add trace information to gRPC invocations is to make use of server and client interceptors. Indeed, 
this is how the <a href="https://github.com/grpc-ecosystem/grpc-opentracing">grpc-opentracing</a> library works. The client interceptor 
extracts the tracing information from the call context and adds it to the remote call as gRPC metadata. The server interceptor 
then extracts the tracing information from gRPC metadata and adds it to the call context on the server side. Unfortunately, 
this method only works flawlessy for unary RPCs. If you have any streaming RPCs, the current <code>ServerStreamInterceptor</code> does not
permit modification of the stream context and your trace data will be inaccurate. One way to work around this is to wrap the 
server stream and the new context in a new <code>ServerStream</code> as follows.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">ServerStreamWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">stream</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerStream</span>
    <span class="nx">ctx</span>    <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">WrapServerStream</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerStream</span><span class="p">,</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="o">*</span><span class="nx">ServerStreamWrapper</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ServerStreamWrapper</span><span class="p">{</span><span class="nx">stream</span><span class="p">:</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ssw</span> <span class="o">*</span><span class="nx">ServerStreamWrapper</span><span class="p">)</span> <span class="nx">SetHeader</span><span class="p">(</span><span class="nx">md</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">MD</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ssw</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">SetHeader</span><span class="p">(</span><span class="nx">md</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ssw</span> <span class="o">*</span><span class="nx">ServerStreamWrapper</span><span class="p">)</span> <span class="nx">SendHeader</span><span class="p">(</span><span class="nx">md</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">MD</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ssw</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">SendHeader</span><span class="p">(</span><span class="nx">md</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ssw</span> <span class="o">*</span><span class="nx">ServerStreamWrapper</span><span class="p">)</span> <span class="nx">SetTrailer</span><span class="p">(</span><span class="nx">md</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">MD</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ssw</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">SetTrailer</span><span class="p">(</span><span class="nx">md</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ssw</span> <span class="o">*</span><span class="nx">ServerStreamWrapper</span><span class="p">)</span> <span class="nx">Context</span><span class="p">()</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ssw</span><span class="p">.</span><span class="nx">ctx</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ssw</span> <span class="o">*</span><span class="nx">ServerStreamWrapper</span><span class="p">)</span> <span class="nx">SendMsg</span><span class="p">(</span><span class="nx">m</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ssw</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">SendMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ssw</span> <span class="o">*</span><span class="nx">ServerStreamWrapper</span><span class="p">)</span> <span class="nx">RecvMsg</span><span class="p">(</span><span class="nx">m</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ssw</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">RecvMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>While this allows us to work around the immutable context in server streams, there are a few problems with this approach:</p>
<ul>
<li>There must be a good reason for why the gRPC developers have made server stream context unmodifiable</li>
<li>If the gRPC <code>ServerStream</code> interface changes in the future, our code will break</li>
<li>Even if the context modification problem is solved, we still do not have a mechanism to detect when the stream ends</li>
</ul>
<p>The full source code of my attempt to use interceptors for tracing can be found here: <a href="https://gist.github.com/charithe/b5956620fa6bb0caf668f857d70a5fc4">https://gist.github.com/charithe/b5956620fa6bb0caf668f857d70a5fc4</a></p>
<p>Given the library limitations and the fact that streams can be live for quite long periods of time, attempting to trace them
might be inadvisable. However, I wanted to see if it was possible to do so, and the unorthodox solution I stumbled on to was to use
the <code>stats.Handler</code> interface now available in the gRPC package. This interface conveniently provides hooks into all the
interesting events that happen during the execution of a gRPC invocation, and can be harnessed to add instrumentation for tracing 
purposes. My implementation of this idea can be found at <a href="https://github.com/charithe/otgrpc">https://github.com/charithe/otgrpc</a>.</p>
<p>One of the issues I came across while implementing the library is that for client-only streams, the end of the stream is not
detected unless an error occurs. I have submitted a <a href="https://github.com/grpc/grpc-go/pull/1140">pull request to the gRPC project</a> to fix this issue, and if it gets merged-in,
full tracing of both unary and streaming RPCs will become posible.</p>
<div class="highlight"><pre><span></span><span class="c1">// Server side</span>

<span class="nx">th</span> <span class="o">:=</span> <span class="nx">otgrpc</span><span class="p">.</span><span class="nx">NewTraceHandler</span><span class="p">(</span><span class="nx">tracer</span><span class="p">,</span> <span class="nx">otgrpc</span><span class="p">.</span><span class="nx">WithPayloadLogging</span><span class="p">())</span>
<span class="nx">server</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">(</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">StatsHandler</span><span class="p">(</span><span class="nx">th</span><span class="p">))</span>
<span class="c1">// register gRPC services and start the server</span>


<span class="c1">// Client side</span>

<span class="nx">th</span> <span class="o">:=</span> <span class="nx">otgrpc</span><span class="p">.</span><span class="nx">NewTraceHandler</span><span class="p">(</span><span class="nx">tracer</span><span class="p">,</span> <span class="nx">otgrpc</span><span class="p">.</span><span class="nx">WithPayloadLogging</span><span class="p">())</span>
<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">WithStatsHandler</span><span class="p">(</span><span class="nx">th</span><span class="p">))</span>
<span class="c1">// create client from the connection</span>
</pre></div>


<p>A race session on a bi-directional stream, captured using <code>opentracing.MockTracer</code> looks as follows:</p>
<div class="highlight"><pre><span></span>traceId=61, spanId=66, parentId=64, sampled=true, name=/test.TestSvc/BidiStreamRPC
    [map[component:gRPC span.kind:server]]
    2017-03-26 17:47:25.735035236 +0100 BST {Key:event ValueKind:string ValueString:Header received: Remote addr=@, Local addr=/tmp/testsvc}
    2017-03-26 17:47:25.735063884 +0100 BST {Key:event ValueKind:string ValueString:RPC started}
    2017-03-26 17:47:25.735071278 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735071278 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping0&quot; }
    2017-03-26 17:47:25.73508489 +0100 BST {Key:event ValueKind:string ValueString:Header sent: Remote addr=%!s(&lt;nil&gt;), Local addr=%!s(&lt;nil&gt;)}
    2017-03-26 17:47:25.73508987 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.73508987 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping0&quot; }
    2017-03-26 17:47:25.735143788 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735143788 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping1&quot; }
    2017-03-26 17:47:25.735152847 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735152847 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping1&quot; }
    2017-03-26 17:47:25.735187024 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735187024 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping2&quot; }
    2017-03-26 17:47:25.735194692 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735194692 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping2&quot; }
    2017-03-26 17:47:25.735232775 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735232775 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping3&quot; }
    2017-03-26 17:47:25.735245634 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735245634 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping3&quot; }
    2017-03-26 17:47:25.735303342 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735303342 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping4&quot; }
    2017-03-26 17:47:25.735320488 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735320488 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping4&quot; }
    2017-03-26 17:47:25.735357374 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=9}
    2017-03-26 17:47:25.735357374 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;OK&quot; }
    2017-03-26 17:47:25.735371044 +0100 BST {Key:event ValueKind:string ValueString:Trailer sent}
    2017-03-26 17:47:25.735375683 +0100 BST {Key:event ValueKind:string ValueString:RPC ended}


traceId=61, spanId=64, parentId=62, sampled=true, name=/test.TestSvc/BidiStreamRPC
    [map[component:gRPC span.kind:client]]
    2017-03-26 17:47:25.734969911 +0100 BST {Key:event ValueKind:string ValueString:RPC started}
    2017-03-26 17:47:25.73499256 +0100 BST {Key:event ValueKind:string ValueString:Header sent: Remote addr=/tmp/testsvc, Local addr=@}
    2017-03-26 17:47:25.735003708 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735003708 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping0&quot; }
    2017-03-26 17:47:25.735095398 +0100 BST {Key:event ValueKind:string ValueString:Header received: Remote addr=%!s(&lt;nil&gt;), Local addr=%!s(&lt;nil&gt;)}
    2017-03-26 17:47:25.73511693 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.73511693 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping0&quot; }
    2017-03-26 17:47:25.735134045 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735134045 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping1&quot; }
    2017-03-26 17:47:25.735166036 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735166036 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping1&quot; }
    2017-03-26 17:47:25.735176586 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735176586 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping2&quot; }
    2017-03-26 17:47:25.735207855 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735207855 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping2&quot; }
    2017-03-26 17:47:25.735220191 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735220191 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping3&quot; }
    2017-03-26 17:47:25.735265907 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735265907 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping3&quot; }
    2017-03-26 17:47:25.735283455 +0100 BST {Key:event ValueKind:string ValueString:Payload sent: Wire length=12}
    2017-03-26 17:47:25.735283455 +0100 BST {Key:payload ValueKind:ptr ValueString:request:&quot;ping4&quot; }
    2017-03-26 17:47:25.735331558 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=7}
    2017-03-26 17:47:25.735331558 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;ping4&quot; }
    2017-03-26 17:47:25.735365117 +0100 BST {Key:event ValueKind:string ValueString:Payload received: Wire length=4}
    2017-03-26 17:47:25.735365117 +0100 BST {Key:payload ValueKind:ptr ValueString:response:&quot;OK&quot; }
    2017-03-26 17:47:25.735377619 +0100 BST {Key:event ValueKind:string ValueString:Trailer received}
    2017-03-26 17:47:25.735394863 +0100 BST {Key:event ValueKind:string ValueString:RPC ended}


traceId=61, spanId=62, parentId=0, sampled=true, name=grpc_op
</pre></div>


        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="http://charithe.github.io/archives.html">Archives</a></li>
                            <li><a href="http://charithe.github.io/tags.html">Tags</a></li>
                            <li><a href="http://charithe.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; 2016-2017  Charith Ellawala </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>